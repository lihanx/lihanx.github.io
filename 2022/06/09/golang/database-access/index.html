
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="技术与生活">
    <title>使用 Golang 访问关系型数据库(译) - 技术与生活</title>
    <meta name="author" content="lihanxuan">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"lihanxuan","sameAs":["https://github.com/lihanx","mailto:lihanx9@163.com"],"image":"profile.jpg"},"articleBody":"\n\n原文: https://go.dev/doc/tutorial/database-access\n\n本教程介绍了使用 Go 和 Go 标准库中的 database/sql 访问关系型数据库的基础知识.\n如果你对 Go 和它的工具有基本的了解, 那么本篇教程将可以发挥它的最大功效. 如果你是第一次接触 Go, 请阅读 Tutorial: Get started with Go, 快速地了解一下 Go.\n你即将使用的 database/sql 包中, 包含了一些数据类型和函数, 可以用于连接数据库、执行会话、取消正在执行的操作, 等等. 关于使用这个包的更多细节, 请见Accessing databases.\n在本篇教程中, 你将要创建一个数据库, 然后编写代码来对这个数据库进行访问. 你将要完成的示例项目, 是一个关于复古爵士乐的曲库.\n在本篇教程中, 你将会按照以下几个小节, 循序渐进地进行学习:\n\n为你的代码创建目录\n设置一个数据库\n导入数据库驱动\n获取一个数据库句柄并进行连接\n查询多行记录\n查询单行记录\n添加数据\n\nNote: 更多其他教程, 请见 Tutorials\n\n前提条件\n已安装 MySQL 关系型数据库管理系统(DBMS).\n已安装 Go. 安装说明, 请见Installing Go.\n代码编辑器. 任何你已有的文本编辑器都可以满足需求.\n命令行终端. Go 可以在 Linux 或 Mac 终端正常工作, 也可以在 Windows 的 PowerShell 或 cmd 中运行.\n\n\n为你的代码创建目录为了开始编写代码, 你需要先创建一个目录.\n1.打开命令行, 进入到 Home 目录\n在 Linux 或者 Mac 上执行如下命令:\n1$ cd\n或在 Windows 上执行以下命令:\n1C:\\&gt; cd %HOMEPATH%\n下文将仅使用 $ 表示命令提示符. 所有命令在 Windows 系统也都同样可以运行.\n2.在命令行提示符后面输入命令, 为你的代码创建一个名为 data-access 的目录.\n12$ mkdir data-access$ cd data-access\n3.创建一个模块, 用来管理你在学习本教程的过程中, 将要添加到项目中的依赖.\n运行 go mod init 命令, 并使用一个你的新代码要用的模块路径(module path)作为参数.\n12$ go mod init example/data-accessgo: createing new go.mod: module example/data-access\n这个命令创建了一个 go.mod 文件用于追踪依赖, 你添加的所有依赖都将会列在这个文件中. 更多内容, 请务必阅读Managing dependencies\nNote: 在实际的开发中, 最好根据你的需求制定一个更具体的模块路径(module path). 更多详情, 请见Managing dependencies\n\n设置一个数据库在这一步, 你将会创建一个需要用到的数据库. 你将使用 DBMS 的 CLI 直接创建数据库和数据表, 并使用 CLI 添加数据.\n你将会创建一个保存黑胶唱片上关于复古爵士乐数据的数据库.\n这里的代码使用 MySQL CLI, 但是大多数 DBMS 都有它们自己的 CLI, 并且拥有相似的功能.\n1.打开一个新的命令提示符2.在命令行中, 登录你的 DBMS, MySQL 的示例如下:\n1234$ mysql -u -pEnter password:mysql&gt;\n3.在 mysql 的命令提示符中, 创建一个数据库:\n1mysql&gt; create datebase recordings;\n4.切换到刚刚添加的数据库中, 以便新增数据表.\n12mysql&gt; use recordings;Database changed\n5.打开文本编辑器, 在 data-access 文件夹中, 创建一个名为 create-tables.sql 的文件, 用于保存创建数据表的 SQL 语句.\n6.打开这个文件, 粘贴如下 SQL 代码并保存:\n12345678910111213141516DROP TABLE IF EXISTS album;CREATE TABLE album (  id         INT AUTO_INCREMENT NOT NULL,  title      VARCHAR(128) NOT NULL,  artist     VARCHAR(255) NOT NULL,  price      DECIMAL(5,2) NOT NULL,  PRIMARY KEY (`id`));INSERT INTO album  (title, artist, price)VALUES  (&#x27;Blue Train&#x27;, &#x27;John Coltrane&#x27;, 56.99),  (&#x27;Giant Steps&#x27;, &#x27;John Coltrane&#x27;, 63.99),  (&#x27;Jeru&#x27;, &#x27;Gerry Mulligan&#x27;, 17.99),  (&#x27;Sarah Vaughan&#x27;, &#x27;Sarah Vaughan&#x27;, 34.98);\n在上述 SQL 代码中, 你进行了以下几项操作:\n\n删除(drop)名为 album 的数据表. 首先执行这个命令主要是为了在日后重新创建这个数据表时, 可以更简单地重新运行这个脚本.\n创建一个 album 表, 包含四个列: title, artist, price 和 id. 每一行的 id 列由 DBMS 自动创建.\n添加四行数据.\n\n7.在 mysql 命令提示符中, 运行你刚刚创建的脚本:\n你将按照以下格式使用 source 命令: \n1mysql&gt; source /path/to/create-tables.sql\n8.在你的 DBMS 命令提示符中, 使用 SELECT 语句来验证你成功创建的数据表和数据.\n12345678910mysql&gt; select * from album;+----+---------------+----------------+-------+| id | title         | artist         | price |+----+---------------+----------------+-------+|  1 | Blue Train    | John Coltrane  | 56.99 ||  2 | Giant Steps   | John Coltrane  | 63.99 ||  3 | Jeru          | Gerry Mulligan | 17.99 ||  4 | Sarah Vaughan | Sarah Vaughan  | 34.98 |+----+---------------+----------------+-------+4 rows in set (0.00 sec)\n下一步, 你将编写一些 Go 代码来连接数据库, 以便进行数据查询.\n\n查找并导入数据库驱动现在你有一个数据库, 并且里面存储了一些数据. 下面开始编写你的 Go 代码.\n找出并导入一个数据库驱动, 你通过 database/sql 库的函数创建的请求, 将会被翻译成为数据库可以理解的请求.\n1.在浏览器中, 打开 SQLDrivers wiki 页面, 找到一个你可以使用的驱动.从这个页面中的列表找到一个你要用的驱动. 本教程中你将会使用 Go-MySQL-Driver 来访问数据库.\n2.注意这里用到的驱动包名, github.com/go-sql-driver/mysql.\n3.使用你的文本编辑器, 创建一个名为 main.go 的文件用来编写 Go 代码, 并保存在你之前创建的 data-access 目录中.\n4.在 main.go 中, 粘贴如下代码导入驱动包:\n123package mainimport &quot;github.com/go-sql-driver/mysql&quot;\n在这段代码中, 你进行了以下操作:\n\n将你的代码添加到 main 包中, 以便它可以独立运行.\n导入 MySQL 驱动 github.com/go-sql-driver/mysql\n\n导入驱动后, 你将要开始编写代码来访问数据库.\n\n获取一个数据库句柄并进行连接现在来编写一些代码, 通过一个数据库句柄, 让你获得数据库的入口.\n你将要使用一个指向 sql.DB 结构体的指针, 来表示一个指定数据库的入口.\n编写代码\n1.打开 main.go 文件, 在你刚刚添加的 import 代码的下方, 粘贴如下 Go 代码来创建一个数据库句柄:\n12345678910111213141516171819202122232425var db *sql.DBfunc main() &#123;    cfg := mysql.Config&#123;        User:   os.Config&#123;            User:   os.Getenv(&quot;DBUSER&quot;),            Passwd: os.Getenv(&quot;DBPASS&quot;),            Net:    &quot;tcp&quot;,            Addr:   &quot;127.0.0.1:3306&quot;,            DBName: &quot;recordings&quot;,        &#125;    &#125;    // Get a database handle    var err error    db, err = sql.Open(&quot;mysql&quot;, cfg.FormatDSN())    if err != nil &#123;        log.Fatal(err)    &#125;    pingErr := db.Ping()    if pingErr != nil &#123;        log.Fatal(pingErr)    &#125;    fmt.Println(&quot;Connected!&quot;)&#125;\n在这段代码中, 你进行了以下几个操作:\n\n声明了一个 *sql.DB 类型的 db 变量. 这就是你的数据库句柄.\n\n把 db 变量作为全局变量, 简化了这个示例. 但是在生产代码中, 你应该避免使用全局变量, 例如将变量作为参数传入函数, 或者将其包装在一个结构体内.\n\n使用 MySQL 驱动的 Config 和 FormatDSN , 把连接的属性集中在一起, 并将他们格式化成 DSN (Database Source Name) 格式, 成为一个连接字符串.\n\n相比于一个连接字符串, Config 结构体使得代码的可读性更强.\n\n调用 sql.Open 来初始化 db 变量, 传入 FormatDSN 的返回值.\n\n检查 sql.Open 返回的异常. sql.Open 有可能会失败, 比如, 当你的数据库连接属性不符合规范的时候.\n\n\n为了简化代码, 你调用了 log.Fatal 来终止代码的运行, 并向控制台输出异常信息. 在生产代码中, 你可能会希望用更平滑的方式来处理异常.\n\n调用 DB.Ping 以确认和数据库的连接是否正常. 在运行时, sql.Open 可能不会立即建立连接, 这取决于驱动. 你在这里使用 Ping 来确认确保 database/sql 包在需要的时候可以连接到数据库.\n\n检查 Ping 返回的异常, 假如连接失败的话.\n\n如果 Ping 连接成功, 打印一条信息.\n\n\n2.在 main.go 文件的顶部, 紧挨着 package 声明的下方, 导入所有你在刚刚编写的那段代码中用到的包.\n编辑后的文件顶部代码如下:\n12345678910package mainimport (    &quot;database/sql&quot;    &quot;fmt&quot;    &quot;log&quot;    &quot;os&quot;    &quot;github.com/go-sql-driver/mysql&quot;)\n3.保存 main.go\n运行代码\n\n将 MySQL 驱动模块作为依赖进行追踪.\n\n使用 go get 命令来把 github.com/go-sql-driver/mysql 模块作为你自己模块的依赖添加进来. 使用 . 参数的意思是“获取当前目录中代码的依赖”.\n12$ go get .go get: added github.com/go-sql-driver/mysql v1.6.0\nGo 完成了对这个依赖的下载, 是因为你在之前的步骤中把它添加到了 import 声明里. 更多关于依赖跟踪的的内容, 请见 Adding a dependency.\n2.在命令提示符界面, 设置 Go 程序需要用到的 DBUSER 和 DBPASS 环境变量.\n在 Linux 或 Mac 系统上执行:\n12$ export DBUSER=username$ export DBPASS=password\n在 Windows 系统上执行:\n12C:\\Users\\you\\daa-access&gt; set DBUSER=usernameC:\\Users\\you\\daa-access&gt; set DBPASS=password\n3.在命令行中, 包含 main.go 的目录下, 输入 go run 命令和点参数(.)来运行代码. 这行命令的含义是“在当前目录下运行这个包”.\n12$ go run .Connected!\n你可以连接数据库了! 下一步, 你将要完成对一些数据的查询.\n\n查询多行记录在这一小节, 你讲使用 Go 来运行一条查询并返回多行数据的 SQL 语句.\n对于可能返回多行数据的 SQL 语句, 你使用 database/sql 包中的 Query 方法, 然后遍历返回的数据行.(你稍后会在 Query for a single row 中学习如何查询单行数据.)\n编写代码\n1.打开 main.go 文件, 在紧挨着 func main 的上方, 粘贴如下代码, 定义一个 Album 结构体. 你将使用这个结构体来储存查询返回的数据行.\n123456type Album struct &#123;    ID      int64    Title   string    Artist  string    Price   float32&#125;\n2.在 func main 的下方, 粘贴下面的 albumsByArtist 函数用于查询数据库.\n1234567891011121314151617181920212223// albumsByArtist 用来查询拥有指定艺术家名称的专辑func albumsByAritist(name string) ([]Album, error) &#123;    // 一个用来保存返回的数据行的 albums slice    var albums []Album    rows, err := db.Query(&quot;SELECT * FROM album WHERE artist = ?&quot;, name)    if err != nil &#123;        return nil, fmt.Errorf(&quot;albumsByArtist %q: %v&quot;, name, err)    &#125;    defer rows.Close()    // 遍历数据行, 使用 Scan 来将每列的数据赋值到结构体的字段上.    for rows.Next() &#123;        var alb Album        if err := rows.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != nil &#123;            return nil, fmt.Errorf(&quot;albumsByArtist %q: %v&quot;, name, err)        &#125;        albums = append(albums, alb)    &#125;    if err := rows.Err(); err != nil &#123;        return nil, fmt.Errorf(&quot;albumsByAritst %q: %v&quot;, name, err)    &#125;    return albums, nil&#125;\n在这段代码中, 你完成了以下几项操作:\n\n声明了一个你定义的 Album 类型的切片变量 albums. 这个切片将用来保存返回的数据行中的数据. 结构体字段名称和类型与数据库列的名称以及类型相对应.\n\n使用 DB.Query 执行 SELECT 语句, 对指定艺术家名称的专辑进行查询.\n\n\nQuery 的第一个参数是 SQL 语句. 在这个参数的后面, 你可以传入零个或多个任意类型的参数. 这给你提供了一个可以为 SQL 语句指定参数值的位置. 通过将 SQL 语句和参数值拆分开 (而不是使用 fmt.Printf 拼接在一起), database/sql 包可以将 SQL 语句文本和值分开传递, 避免了 SQL 注入的风险.\n\n使用 Defer 关闭 rows, 使它持有的资源 可以在函数退出时释放.\n\n遍历返回的全部数据行, 使用 Rows.Scan 来将每个数据行中各列的数据赋值到 Album 结构体的字段中.\n\n\nScan 接收一系列 Go 值的指针, 各列的值将会写入这些指针指向的位置. 在这里, 你使用 &amp; 操作符创建了指向 alb 变量中不同字段的指针, 并将它们传入 Scan 中. Scan 通过这些指针写入数据, 对结构体的字段进行更新.\n\n在循环中, 校验列数据赋值到结构体字段时返回的异常.\n\n在循环中, 把新的 alb 追加到 albums 切片中.\n\n在循环之后, 使用 rows.Err 校验整个查询过程中的异常, 注意如果查询本身失败了, 而想要发现结果不完整, 在这里进行异常校验是唯一的方式.\n\n\n3.更新你的 main 函数, 对 albumsByArtist 进行调用.\n向 func main 的末尾, 添加如下代码:\n12345albums, err := albumsByArtist(&quot;John Coltrane&quot;)if err != nil &#123;    log.Fatal(err)&#125;fmt.Printf(&quot;Albums found: %v\\n&quot;, albums)\n在新增的代码中, 你现在完成了以下操作:\n\n调用你添加的 albumsByArtist 函数, 将返回值赋值到新的 albums 变量上.\n打印结果\n\n运行代码\n打开命令行, 在 main.go 所在的目录下, 运行代码.\n123$ go run .Connected!Albums found: [&#123;1 Blue Train John Coltrane 56.99&#125; &#123;2 Giant Steps John Coltrane 63.99&#125;]\n下一步, 你将会查询单行数据.\n\n查询单行记录在本小节, 你将使用 Go 来完成对数据库中单行数据的查询.\n对于你已知的最多只会返回一个数据行的 SQL 语句, 你可以使用 QueryRow, 这样比使用 Query 循环更加简单.\n编写代码\n1.在 albumsByArtist 的下方, 粘贴 albumByID 函数代码如下:\n1234567891011121314// albumByID 通过指定 ID 查询专辑func albumByID(id int64) (Album, error) &#123;    // 保存查询返回的专辑数据    var alb Album    row := db.QueryRow(&quot;SELECT * FROM album WHERE id = ?&quot;, id)    if err := row.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != nil &#123;        if err == sql.ErrNoRows &#123;            return alb, fmt.Errorf(&quot;albumsById %d: no such album&quot;, id)        &#125;        return alb, fmt.Errorf(&quot;albumsById %d: %v&quot;, id, err)    &#125;    return alb, nil&#125;\n在这段代码中, 你完成了以下操作:\n\n使用 DB.QueryRow 执行了 SELECT 语句, 根据指定的 ID 对专辑进行查询.\n\nDB.QueryRow 返回了一个 sql.Row. 为了简化你的代码, QueryRow 并没有返回异常. 而是把查询异常(比如 sql.ErrNoRows)放到了 Rows.Scan 后面.\n\n使用 Row.Scan 将每列的值赋值到结构体字段中\n\n校验 Scan 返回的异常\n\n\n这个特殊的 sql.ErrNoRows 异常表示查询没有任何一条结果返回. 这个异常通常有必要使用更明确的文本信息替代, 比如这里的 “no such album”.\n2.更新 main 函数, 对 albumByID 进行调用\n向 func main 的末尾, 添加如下代码:\n123456// 在这里硬编码 ID 为 2 用于查询测试alb, err := albumByID(2)if err != nil &#123;    log.Fatal(err)&#125;fmt.Printf(&quot;Album found: %v\\n&quot;, alb)\n在这段新增代码中, 你完成了以下操作:\n\n调用了你添加的 albumByID 函数\n打印了这个专辑 ID 的返回值\n\n运行代码\n打开命令行, 在 main.go 所在的目录, 运行代码.\n1234$ go run .Connected!Albums found: [&#123;1 Blue Train John Coltrane 56.99&#125; &#123;2 Giant Steps John Coltrane 63.99&#125;]Album found: &#123;2 Giant Steps John Coltrane 63.99&#125;\n下一步, 你将会添加一条专辑信息到数据库中.\n\n添加数据在本小节, 你将使用 Go 执行 SQL 的 INSERT 语句, 来添加一条新数据到数据库中.\n你已经了解到了如何使用 Query 和 QueryRow 两个有返回数据的函数来执行 SQL 语句. 那么对于不返回数据的 SQL 语句, 你需要使用 Exec\n编写代码\n1.在 albumByID 函数的下方, 粘贴 addAlbum 函数的代码如下, 用于添加一条新的专辑数据到数据库中, 然后保存 main.go 文件.\n12345678910111213// addAlbum 添加指定的专辑信息到数据库中// 返回新数据到专辑 IDfunc addAlbum(alb Album) (int64, error) &#123;    result, err := db.Exec(&quot;INSERT INTO album (title, artist, price) VALUES (?, ?, ?)&quot;, alb.Title, alb.Artist, alb.Price)    if err != nil &#123;        return 0, fmt.Errorf(&quot;addAlbum: %v&quot;, err)    &#125;    id, err := result.LastInsertId()    if err != nil &#123;        return 0, fmt.Errorf(&quot;addAlbum: %v&quot;, err)    &#125;    return id, nil&#125;\n在这段代码中, 你完成了以下操作:\n\n使用 DB.Exec 执行了 INSERT 语句就像 Query 一样, Exec 接收 SQL 语句和这个 SQL 语句的参数值.\n校验尝试执行 INSERT 语句时返回的异常\n使用 Result.LastInsertId 取回新插入数据的 ID.\n校验尝试取回 ID 时返回的异常.\n\n2.更新 main 函数对新增的 addAlbum 函数进行调用.\n向 func main 的末尾, 添加如下代码:\n123456789albID, err := addAlbum(Album&#123;    Title:  &quot;The modern Sound of Betty Carter&quot;,    Artist: &quot;Betty Carter&quot;,    Price:  49.99,&#125;)if err != nil &#123;    log.Fatal(err)&#125;fmt.Printf(&quot;ID of added album: %v\\n&quot;, albID)\n在这段新增代码中, 你现在完成了以下操作:\n\n调用 addAlbum 并使用一个新专辑信息作为参数, 将你添加的专辑信息 ID 赋值给一个 albID 变量.\n\n运行代码\n打开命令行, 在 main.go 所在的目录下, 运行代码.\n12345$ go run .Connected!Albums found: [&#123;1 Blue Train John Coltrane 56.99&#125; &#123;2 Giant Steps John Coltrane 63.99&#125;]Album found: &#123;2 Giant Steps John Coltrane 63.99&#125;ID of added album: 5\n\n总结恭喜你! 你刚刚使用 Go 完成了一些对关系型数据库的简单操作.\n接下来的一些建议:\n\n阅读一下数据存取指南(data access guide), 有一些本教程仅仅浅尝辄止的内容, 在数据存取指南中有更详细的介绍.\n如果你刚刚开始使用 Go, 你可以在 Effective Go 和 How to wirte Go code 中找到非常有用的 Go 语言最佳实践.\nGo Tour 是一个非常好的入门教程, 循序渐进地介绍了 Go 语言的基础.\n\n\n完整代码本小节包含了你跟随本教程构建的程序的完整代码.\n123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118package mainimport (    &quot;database/sql&quot;    &quot;fmt&quot;    &quot;log&quot;    &quot;os&quot;    &quot;github.com/go-sql-driver/mysql&quot;)var db *sql.DBtype Album struct &#123;    ID     int64    Title  string    Artist string    Price  float32&#125;func main() &#123;    // Capture connection properties.    cfg := mysql.Config&#123;        User:   os.Getenv(&quot;DBUSER&quot;),        Passwd: os.Getenv(&quot;DBPASS&quot;),        Net:    &quot;tcp&quot;,        Addr:   &quot;127.0.0.1:3306&quot;,        DBName: &quot;recordings&quot;,    &#125;    // Get a database handle.    var err error    db, err = sql.Open(&quot;mysql&quot;, cfg.FormatDSN())    if err != nil &#123;        log.Fatal(err)    &#125;    pingErr := db.Ping()    if pingErr != nil &#123;        log.Fatal(pingErr)    &#125;    fmt.Println(&quot;Connected!&quot;)    albums, err := albumsByArtist(&quot;John Coltrane&quot;)    if err != nil &#123;        log.Fatal(err)    &#125;    fmt.Printf(&quot;Albums found: %v\\n&quot;, albums)    // Hard-code ID 2 here to test the query.    alb, err := albumByID(2)    if err != nil &#123;        log.Fatal(err)    &#125;    fmt.Printf(&quot;Album found: %v\\n&quot;, alb)    albID, err := addAlbum(Album&#123;        Title:  &quot;The Modern Sound of Betty Carter&quot;,        Artist: &quot;Betty Carter&quot;,        Price:  49.99,    &#125;)    if err != nil &#123;        log.Fatal(err)    &#125;    fmt.Printf(&quot;ID of added album: %v\\n&quot;, albID)&#125;// albumsByArtist queries for albums that have the specified artist name.func albumsByArtist(name string) ([]Album, error) &#123;    // An albums slice to hold data from returned rows.    var albums []Album    rows, err := db.Query(&quot;SELECT * FROM album WHERE artist = ?&quot;, name)    if err != nil &#123;        return nil, fmt.Errorf(&quot;albumsByArtist %q: %v&quot;, name, err)    &#125;    defer rows.Close()    // Loop through rows, using Scan to assign column data to struct fields.    for rows.Next() &#123;        var alb Album        if err := rows.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != nil &#123;            return nil, fmt.Errorf(&quot;albumsByArtist %q: %v&quot;, name, err)        &#125;        albums = append(albums, alb)    &#125;    if err := rows.Err(); err != nil &#123;        return nil, fmt.Errorf(&quot;albumsByArtist %q: %v&quot;, name, err)    &#125;    return albums, nil&#125;// albumByID queries for the album with the specified ID.func albumByID(id int64) (Album, error) &#123;    // An album to hold data from the returned row.    var alb Album    row := db.QueryRow(&quot;SELECT * FROM album WHERE id = ?&quot;, id)    if err := row.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != nil &#123;        if err == sql.ErrNoRows &#123;            return alb, fmt.Errorf(&quot;albumsById %d: no such album&quot;, id)        &#125;        return alb, fmt.Errorf(&quot;albumsById %d: %v&quot;, id, err)    &#125;    return alb, nil&#125;// addAlbum adds the specified album to the database,// returning the album ID of the new entryfunc addAlbum(alb Album) (int64, error) &#123;    result, err := db.Exec(&quot;INSERT INTO album (title, artist, price) VALUES (?, ?, ?)&quot;, alb.Title, alb.Artist, alb.Price)    if err != nil &#123;        return 0, fmt.Errorf(&quot;addAlbum: %v&quot;, err)    &#125;    id, err := result.LastInsertId()    if err != nil &#123;        return 0, fmt.Errorf(&quot;addAlbum: %v&quot;, err)    &#125;    return id, nil&#125;","dateCreated":"2022-06-09T16:00:00+00:00","dateModified":"2022-06-12T03:28:35+00:00","datePublished":"2022-06-09T16:00:00+00:00","description":"","headline":"使用 Golang 访问关系型数据库(译)","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://lihanx.github.io/2022/06/09/golang/database-access/"},"publisher":{"@type":"Organization","name":"lihanxuan","sameAs":["https://github.com/lihanx","mailto:lihanx9@163.com"],"image":"profile.jpg","logo":{"@type":"ImageObject","url":"profile.jpg"}},"url":"https://lihanx.github.io/2022/06/09/golang/database-access/","keywords":"Golang, 翻译"}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="使用 Golang 访问关系型数据库(译)">
<meta property="og:url" content="https://lihanx.github.io/2022/06/09/golang/database-access/">
<meta property="og:site_name" content="技术与生活">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-06-09T16:00:00.000Z">
<meta property="article:modified_time" content="2022-06-12T03:28:35.143Z">
<meta property="article:author" content="lihanxuan">
<meta property="article:tag" content="Golang">
<meta property="article:tag" content="翻译">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="https://lihanx.github.io/assets/images/profile.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-xauyfozqtqozcpsrphukridnjkr9dhe8pwadzdb0xqjt4tr2luvsk6bxwf84.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZF6GHC927L"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-ZF6GHC927L');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            技术与生活
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/profile.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/profile.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">lihanxuan</h4>
                
                    <h5 class="sidebar-profile-bio"><p>持续学习, 不断探索</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/lihanx"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:lihanx9@163.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            使用 Golang 访问关系型数据库(译)
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2022-06-09T16:00:00+00:00">
	
		    2022年 6月 09日
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Golang/">Golang</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <!-- excerpt -->
<blockquote>
<p>原文: <a target="_blank" rel="noopener" href="https://go.dev/doc/tutorial/database-access">https://go.dev/doc/tutorial/database-access</a></p>
</blockquote>
<p>本教程介绍了使用 Go 和 Go 标准库中的 <code>database/sql</code> 访问关系型数据库的基础知识.</p>
<p>如果你对 Go 和它的工具有基本的了解, 那么本篇教程将可以发挥它的最大功效. 如果你是第一次接触 Go, 请阅读 <a target="_blank" rel="noopener" href="https://go.dev/doc/tutorial/getting-started">Tutorial: Get started with Go</a>, 快速地了解一下 Go.</p>
<p>你即将使用的 <code>database/sql</code> 包中, 包含了一些数据类型和函数, 可以用于连接数据库、执行会话、取消正在执行的操作, 等等. 关于使用这个包的更多细节, 请见<a target="_blank" rel="noopener" href="https://go.dev/doc/database/index">Accessing databases</a>.</p>
<p>在本篇教程中, 你将要创建一个数据库, 然后编写代码来对这个数据库进行访问. 你将要完成的示例项目, 是一个关于复古爵士乐的曲库.</p>
<p>在本篇教程中, 你将会按照以下几个小节, 循序渐进地进行学习:</p>
<ol>
<li>为你的代码创建目录</li>
<li>设置一个数据库</li>
<li>导入数据库驱动</li>
<li>获取一个数据库句柄并进行连接</li>
<li>查询多行记录</li>
<li>查询单行记录</li>
<li>添加数据</li>
</ol>
<p><strong>Note:</strong> 更多其他教程, 请见 <a target="_blank" rel="noopener" href="https://go.dev/doc/tutorial/index.html">Tutorials</a></p>
<p><br/></p>
<h2 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h2><ul>
<li><strong>已安装 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/">MySQL</a> 关系型数据库管理系统(DBMS).</strong></li>
<li><strong>已安装 Go.</strong> 安装说明, 请见<a target="_blank" rel="noopener" href="https://go.dev/doc/install">Installing Go</a>.</li>
<li><strong>代码编辑器.</strong> 任何你已有的文本编辑器都可以满足需求.</li>
<li><strong>命令行终端.</strong> Go 可以在 Linux 或 Mac 终端正常工作, 也可以在 Windows 的 PowerShell 或 cmd 中运行.</li>
</ul>
<p><br/></p>
<h2 id="为你的代码创建目录"><a href="#为你的代码创建目录" class="headerlink" title="为你的代码创建目录"></a>为你的代码创建目录</h2><p>为了开始编写代码, 你需要先创建一个目录.</p>
<p>1.打开命令行, 进入到 Home 目录</p>
<p>在 Linux 或者 Mac 上执行如下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span></span><br></pre></td></tr></table></figure>
<p>或在 Windows 上执行以下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\&gt; <span class="built_in">cd</span> %HOMEPATH%</span><br></pre></td></tr></table></figure>
<p>下文将仅使用 <code>$</code> 表示命令提示符. 所有命令在 Windows 系统也都同样可以运行.</p>
<p>2.在命令行提示符后面输入命令, 为你的代码创建一个名为 data-access 的目录.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir data-access</span><br><span class="line">$ <span class="built_in">cd</span> data-access</span><br></pre></td></tr></table></figure>
<p>3.创建一个模块, 用来管理你在学习本教程的过程中, 将要添加到项目中的依赖.</p>
<p>运行 <code>go mod init</code> 命令, 并使用一个你的新代码要用的模块路径(module path)作为参数.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go mod init example/data-access</span><br><span class="line">go: createing new go.mod: module example/data-access</span><br></pre></td></tr></table></figure>
<p>这个命令创建了一个 go.mod 文件用于追踪依赖, 你添加的所有依赖都将会列在这个文件中. 更多内容, 请务必阅读<a target="_blank" rel="noopener" href="https://go.dev/doc/modules/managing-dependencies">Managing dependencies</a></p>
<p><strong>Note:</strong> 在实际的开发中, 最好根据你的需求制定一个更具体的模块路径(module path). 更多详情, 请见<a target="_blank" rel="noopener" href="https://go.dev/doc/modules/managing-dependencies#naming_module">Managing dependencies</a></p>
<p><br/></p>
<h2 id="设置一个数据库"><a href="#设置一个数据库" class="headerlink" title="设置一个数据库"></a>设置一个数据库</h2><p>在这一步, 你将会创建一个需要用到的数据库. 你将使用 DBMS 的 CLI 直接创建数据库和数据表, 并使用 CLI 添加数据.</p>
<p>你将会创建一个保存黑胶唱片上关于复古爵士乐数据的数据库.</p>
<p>这里的代码使用 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/mysql.html">MySQL CLI</a>, 但是大多数 DBMS 都有它们自己的 CLI, 并且拥有相似的功能.</p>
<p>1.打开一个新的命令提示符<br>2.在命令行中, 登录你的 DBMS, MySQL 的示例如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -u -p</span><br><span class="line">Enter password:</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<p>3.在 mysql 的命令提示符中, 创建一个数据库:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create datebase recordings;</span><br></pre></td></tr></table></figure>
<p>4.切换到刚刚添加的数据库中, 以便新增数据表.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use recordings;</span><br><span class="line">Database changed</span><br></pre></td></tr></table></figure>
<p>5.打开文本编辑器, 在 data-access 文件夹中, 创建一个名为 create-tables.sql 的文件, 用于保存创建数据表的 SQL 语句.</p>
<p>6.打开这个文件, 粘贴如下 SQL 代码并保存:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> album;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> album (</span><br><span class="line">  <span class="keyword">id</span>         <span class="built_in">INT</span> AUTO_INCREMENT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  title      <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  artist     <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  price      <span class="built_in">DECIMAL</span>(<span class="number">5</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> album</span><br><span class="line">  (title, artist, price)</span><br><span class="line"><span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">&#x27;Blue Train&#x27;</span>, <span class="string">&#x27;John Coltrane&#x27;</span>, <span class="number">56.99</span>),</span><br><span class="line">  (<span class="string">&#x27;Giant Steps&#x27;</span>, <span class="string">&#x27;John Coltrane&#x27;</span>, <span class="number">63.99</span>),</span><br><span class="line">  (<span class="string">&#x27;Jeru&#x27;</span>, <span class="string">&#x27;Gerry Mulligan&#x27;</span>, <span class="number">17.99</span>),</span><br><span class="line">  (<span class="string">&#x27;Sarah Vaughan&#x27;</span>, <span class="string">&#x27;Sarah Vaughan&#x27;</span>, <span class="number">34.98</span>);</span><br></pre></td></tr></table></figure>
<p>在上述 SQL 代码中, 你进行了以下几项操作:</p>
<ul>
<li>删除(drop)名为 <code>album</code> 的数据表. 首先执行这个命令主要是为了在日后重新创建这个数据表时, 可以更简单地重新运行这个脚本.</li>
<li>创建一个 <code>album</code> 表, 包含四个列: <code>title</code>, <code>artist</code>, <code>price</code> 和 <code>id</code>. 每一行的 <code>id</code> 列由 DBMS 自动创建.</li>
<li>添加四行数据.</li>
</ul>
<p>7.在 <code>mysql</code> 命令提示符中, 运行你刚刚创建的脚本:</p>
<p>你将按照以下格式使用 <code>source</code> 命令: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="built_in">source</span> /path/to/create-tables.sql</span><br></pre></td></tr></table></figure>
<p>8.在你的 DBMS 命令提示符中, 使用 <code>SELECT</code> 语句来验证你成功创建的数据表和数据.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from album;</span><br><span class="line">+----+---------------+----------------+-------+</span><br><span class="line">| id | title         | artist         | price |</span><br><span class="line">+----+---------------+----------------+-------+</span><br><span class="line">|  1 | Blue Train    | John Coltrane  | 56.99 |</span><br><span class="line">|  2 | Giant Steps   | John Coltrane  | 63.99 |</span><br><span class="line">|  3 | Jeru          | Gerry Mulligan | 17.99 |</span><br><span class="line">|  4 | Sarah Vaughan | Sarah Vaughan  | 34.98 |</span><br><span class="line">+----+---------------+----------------+-------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>下一步, 你将编写一些 Go 代码来连接数据库, 以便进行数据查询.</p>
<p><br/></p>
<h2 id="查找并导入数据库驱动"><a href="#查找并导入数据库驱动" class="headerlink" title="查找并导入数据库驱动"></a>查找并导入数据库驱动</h2><p>现在你有一个数据库, 并且里面存储了一些数据. 下面开始编写你的 Go 代码.</p>
<p>找出并导入一个数据库驱动, 你通过 <code>database/sql</code> 库的函数创建的请求, 将会被翻译成为数据库可以理解的请求.</p>
<p>1.在浏览器中, 打开 <a target="_blank" rel="noopener" href="https://github.com/golang/go/wiki/SQLDrivers">SQLDrivers</a> wiki 页面, 找到一个你可以使用的驱动.<br>从这个页面中的列表找到一个你要用的驱动. 本教程中你将会使用 <a target="_blank" rel="noopener" href="https://github.com/go-sql-driver/mysql/">Go-MySQL-Driver</a> 来访问数据库.</p>
<p>2.注意这里用到的驱动包名, <code>github.com/go-sql-driver/mysql</code>.</p>
<p>3.使用你的文本编辑器, 创建一个名为 main.go 的文件用来编写 Go 代码, 并保存在你之前创建的 data-access 目录中.</p>
<p>4.在 main.go 中, 粘贴如下代码导入驱动包:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br></pre></td></tr></table></figure>
<p>在这段代码中, 你进行了以下操作:</p>
<ul>
<li>将你的代码添加到 <code>main</code> 包中, 以便它可以独立运行.</li>
<li>导入 MySQL 驱动 <code>github.com/go-sql-driver/mysql</code></li>
</ul>
<p>导入驱动后, 你将要开始编写代码来访问数据库.</p>
<p><br/></p>
<h2 id="获取一个数据库句柄并进行连接"><a href="#获取一个数据库句柄并进行连接" class="headerlink" title="获取一个数据库句柄并进行连接"></a>获取一个数据库句柄并进行连接</h2><p>现在来编写一些代码, 通过一个数据库句柄, 让你获得数据库的入口.</p>
<p>你将要使用一个指向 <code>sql.DB</code> 结构体的指针, 来表示一个指定数据库的入口.</p>
<p><strong>编写代码</strong></p>
<p>1.打开 main.go 文件, 在你刚刚添加的 <code>import</code> 代码的下方, 粘贴如下 Go 代码来创建一个数据库句柄:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cfg := mysql.Config&#123;</span><br><span class="line">        User:   os.Config&#123;</span><br><span class="line">            User:   os.Getenv(<span class="string">&quot;DBUSER&quot;</span>),</span><br><span class="line">            Passwd: os.Getenv(<span class="string">&quot;DBPASS&quot;</span>),</span><br><span class="line">            Net:    <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">            Addr:   <span class="string">&quot;127.0.0.1:3306&quot;</span>,</span><br><span class="line">            DBName: <span class="string">&quot;recordings&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Get a database handle</span></span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, cfg.FormatDSN())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pingErr := db.Ping()</span><br><span class="line">    <span class="keyword">if</span> pingErr != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(pingErr)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Connected!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这段代码中, 你进行了以下几个操作:</p>
<ul>
<li>声明了一个 <code>*sql.DB</code> 类型的 <code>db</code> 变量. 这就是你的数据库句柄.</li>
</ul>
<p>把 <code>db</code> 变量作为全局变量, 简化了这个示例. 但是在生产代码中, 你应该避免使用全局变量, 例如将变量作为参数传入函数, 或者将其包装在一个结构体内.</p>
<ul>
<li>使用 MySQL 驱动的 <code>Config</code> 和 <code>FormatDSN</code> , 把连接的属性集中在一起, 并将他们格式化成 DSN (Database Source Name) 格式, 成为一个连接字符串.</li>
</ul>
<p>相比于一个连接字符串, <code>Config</code> 结构体使得代码的可读性更强.</p>
<ul>
<li><p>调用 <code>sql.Open</code> 来初始化 <code>db</code> 变量, 传入 <code>FormatDSN</code> 的返回值.</p>
</li>
<li><p>检查 <code>sql.Open</code> 返回的异常. <code>sql.Open</code> 有可能会失败, 比如, 当你的数据库连接属性不符合规范的时候.</p>
</li>
</ul>
<p>为了简化代码, 你调用了 <code>log.Fatal</code> 来终止代码的运行, 并向控制台输出异常信息. 在生产代码中, 你可能会希望用更平滑的方式来处理异常.</p>
<ul>
<li><p>调用 <code>DB.Ping</code> 以确认和数据库的连接是否正常. 在运行时, <code>sql.Open</code> 可能不会立即建立连接, 这取决于驱动. 你在这里使用 <code>Ping</code> 来确认确保 <code>database/sql</code> 包在需要的时候可以连接到数据库.</p>
</li>
<li><p>检查 <code>Ping</code> 返回的异常, 假如连接失败的话.</p>
</li>
<li><p>如果 <code>Ping</code> 连接成功, 打印一条信息.</p>
</li>
</ul>
<p>2.在 main.go 文件的顶部, 紧挨着 package 声明的下方, 导入所有你在刚刚编写的那段代码中用到的包.</p>
<p>编辑后的文件顶部代码如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>3.保存 main.go</p>
<p><strong>运行代码</strong></p>
<ol>
<li>将 MySQL 驱动模块作为依赖进行追踪.</li>
</ol>
<p>使用 <code>go get</code> 命令来把 github.com/go-sql-driver/mysql 模块作为你自己模块的依赖添加进来. 使用 <code>.</code> 参数的意思是“获取当前目录中代码的依赖”.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go get .</span><br><span class="line">go get: added github.com/go-sql-driver/mysql v1.6.0</span><br></pre></td></tr></table></figure>
<p>Go 完成了对这个依赖的下载, 是因为你在之前的步骤中把它添加到了 <code>import</code> 声明里. 更多关于依赖跟踪的的内容, 请见 <a target="_blank" rel="noopener" href="https://go.dev/doc/modules/managing-dependencies#adding_dependency">Adding a dependency</a>.</p>
<p>2.在命令提示符界面, 设置 Go 程序需要用到的 <code>DBUSER</code> 和 <code>DBPASS</code> 环境变量.</p>
<p>在 Linux 或 Mac 系统上执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> DBUSER=username</span><br><span class="line">$ <span class="built_in">export</span> DBPASS=password</span><br></pre></td></tr></table></figure>
<p>在 Windows 系统上执行:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\you\daa-access&gt; <span class="built_in">set</span> DBUSER=username</span><br><span class="line">C:\Users\you\daa-access&gt; <span class="built_in">set</span> DBPASS=password</span><br></pre></td></tr></table></figure>
<p>3.在命令行中, 包含 main.go 的目录下, 输入 <code>go run</code> 命令和点参数(<code>.</code>)来运行代码. 这行命令的含义是“在当前目录下运行这个包”.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run .</span><br><span class="line">Connected!</span><br></pre></td></tr></table></figure>
<p>你可以连接数据库了! 下一步, 你将要完成对一些数据的查询.</p>
<p><br/></p>
<h2 id="查询多行记录"><a href="#查询多行记录" class="headerlink" title="查询多行记录"></a>查询多行记录</h2><p>在这一小节, 你讲使用 Go 来运行一条查询并返回多行数据的 SQL 语句.</p>
<p>对于可能返回多行数据的 SQL 语句, 你使用 <code>database/sql</code> 包中的 <code>Query</code> 方法, 然后遍历返回的数据行.(你稍后会在 <a target="_blank" rel="noopener" href="https://go.dev/doc/tutorial/database-access#single_row">Query for a single row</a> 中学习如何查询单行数据.)</p>
<p><strong>编写代码</strong></p>
<p>1.打开 main.go 文件, 在紧挨着 <code>func main</code> 的上方, 粘贴如下代码, 定义一个 <code>Album</code> 结构体. 你将使用这个结构体来储存查询返回的数据行.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Album <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID      <span class="keyword">int64</span></span><br><span class="line">    Title   <span class="keyword">string</span></span><br><span class="line">    Artist  <span class="keyword">string</span></span><br><span class="line">    Price   <span class="keyword">float32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.在 <code>func main</code> 的下方, 粘贴下面的 <code>albumsByArtist</code> 函数用于查询数据库.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// albumsByArtist 用来查询拥有指定艺术家名称的专辑</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">albumsByAritist</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">([]Album, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 一个用来保存返回的数据行的 albums slice</span></span><br><span class="line">    <span class="keyword">var</span> albums []Album</span><br><span class="line"></span><br><span class="line">    rows, err := db.Query(<span class="string">&quot;SELECT * FROM album WHERE artist = ?&quot;</span>, name)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;albumsByArtist %q: %v&quot;</span>, name, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()</span><br><span class="line">    <span class="comment">// 遍历数据行, 使用 Scan 来将每列的数据赋值到结构体的字段上.</span></span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> alb Album</span><br><span class="line">        <span class="keyword">if</span> err := rows.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;albumsByArtist %q: %v&quot;</span>, name, err)</span><br><span class="line">        &#125;</span><br><span class="line">        albums = <span class="built_in">append</span>(albums, alb)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := rows.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;albumsByAritst %q: %v&quot;</span>, name, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> albums, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这段代码中, 你完成了以下几项操作:</p>
<ul>
<li><p>声明了一个你定义的 <code>Album</code> 类型的切片变量 <code>albums</code>. 这个切片将用来保存返回的数据行中的数据. 结构体字段名称和类型与数据库列的名称以及类型相对应.</p>
</li>
<li><p>使用 <code>DB.Query</code> 执行 <code>SELECT</code> 语句, 对指定艺术家名称的专辑进行查询.</p>
</li>
</ul>
<p><code>Query</code> 的第一个参数是 SQL 语句. 在这个参数的后面, 你可以传入零个或多个任意类型的参数. 这给你提供了一个可以为 SQL 语句指定参数值的位置. 通过将 SQL 语句和参数值拆分开 (而不是使用 <code>fmt.Printf</code> 拼接在一起), <code>database/sql</code> 包可以将 SQL 语句文本和值分开传递, 避免了 SQL 注入的风险.</p>
<ul>
<li><p>使用 Defer 关闭 <code>rows</code>, 使它持有的资源 可以在函数退出时释放.</p>
</li>
<li><p>遍历返回的全部数据行, 使用 <code>Rows.Scan</code> 来将每个数据行中各列的数据赋值到 <code>Album</code> 结构体的字段中.</p>
</li>
</ul>
<p><code>Scan</code> 接收一系列 Go 值的指针, 各列的值将会写入这些指针指向的位置. 在这里, 你使用 <code>&amp;</code> 操作符创建了指向 <code>alb</code> 变量中不同字段的指针, 并将它们传入 <code>Scan</code> 中. <code>Scan</code> 通过这些指针写入数据, 对结构体的字段进行更新.</p>
<ul>
<li><p>在循环中, 校验列数据赋值到结构体字段时返回的异常.</p>
</li>
<li><p>在循环中, 把新的 <code>alb</code> 追加到 <code>albums</code> 切片中.</p>
</li>
<li><p>在循环之后, 使用 <code>rows.Err</code> 校验整个查询过程中的异常, 注意如果查询本身失败了, 而想要发现结果不完整, 在这里进行异常校验是唯一的方式.</p>
</li>
</ul>
<p>3.更新你的 <code>main</code> 函数, 对 <code>albumsByArtist</code> 进行调用.</p>
<p>向 <code>func main</code> 的末尾, 添加如下代码:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">albums, err := albumsByArtist(<span class="string">&quot;John Coltrane&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Albums found: %v\n&quot;</span>, albums)</span><br></pre></td></tr></table></figure>
<p>在新增的代码中, 你现在完成了以下操作:</p>
<ul>
<li>调用你添加的 <code>albumsByArtist</code> 函数, 将返回值赋值到新的 <code>albums</code> 变量上.</li>
<li>打印结果</li>
</ul>
<p><strong>运行代码</strong></p>
<p>打开命令行, 在 main.go 所在的目录下, 运行代码.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go run .</span><br><span class="line">Connected!</span><br><span class="line">Albums found: [&#123;1 Blue Train John Coltrane 56.99&#125; &#123;2 Giant Steps John Coltrane 63.99&#125;]</span><br></pre></td></tr></table></figure>
<p>下一步, 你将会查询单行数据.</p>
<p><br/></p>
<h2 id="查询单行记录"><a href="#查询单行记录" class="headerlink" title="查询单行记录"></a>查询单行记录</h2><p>在本小节, 你将使用 Go 来完成对数据库中单行数据的查询.</p>
<p>对于你已知的最多只会返回一个数据行的 SQL 语句, 你可以使用 <code>QueryRow</code>, 这样比使用 <code>Query</code> 循环更加简单.</p>
<p><strong>编写代码</strong></p>
<p>1.在 <code>albumsByArtist</code> 的下方, 粘贴 <code>albumByID</code> 函数代码如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// albumByID 通过指定 ID 查询专辑</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">albumByID</span><span class="params">(id <span class="keyword">int64</span>)</span> <span class="params">(Album, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 保存查询返回的专辑数据</span></span><br><span class="line">    <span class="keyword">var</span> alb Album</span><br><span class="line"></span><br><span class="line">    row := db.QueryRow(<span class="string">&quot;SELECT * FROM album WHERE id = ?&quot;</span>, id)</span><br><span class="line">    <span class="keyword">if</span> err := row.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err == sql.ErrNoRows &#123;</span><br><span class="line">            <span class="keyword">return</span> alb, fmt.Errorf(<span class="string">&quot;albumsById %d: no such album&quot;</span>, id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> alb, fmt.Errorf(<span class="string">&quot;albumsById %d: %v&quot;</span>, id, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> alb, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这段代码中, 你完成了以下操作:</p>
<ul>
<li>使用 <code>DB.QueryRow</code> 执行了 <code>SELECT</code> 语句, 根据指定的 ID 对专辑进行查询.</li>
</ul>
<p><code>DB.QueryRow</code> 返回了一个 <code>sql.Row</code>. 为了简化你的代码, <code>QueryRow</code> 并没有返回异常. 而是把查询异常(比如 <code>sql.ErrNoRows</code>)放到了 <code>Rows.Scan</code> 后面.</p>
<ul>
<li><p>使用 <code>Row.Scan</code> 将每列的值赋值到结构体字段中</p>
</li>
<li><p>校验 <code>Scan</code> 返回的异常</p>
</li>
</ul>
<p>这个特殊的 <code>sql.ErrNoRows</code> 异常表示查询没有任何一条结果返回. 这个异常通常有必要使用更明确的文本信息替代, 比如这里的 “no such album”.</p>
<p>2.更新 <code>main</code> 函数, 对 <code>albumByID</code> 进行调用</p>
<p>向 <code>func main</code> 的末尾, 添加如下代码:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在这里硬编码 ID 为 2 用于查询测试</span></span><br><span class="line">alb, err := albumByID(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Album found: %v\n&quot;</span>, alb)</span><br></pre></td></tr></table></figure>
<p>在这段新增代码中, 你完成了以下操作:</p>
<ul>
<li>调用了你添加的 <code>albumByID</code> 函数</li>
<li>打印了这个专辑 ID 的返回值</li>
</ul>
<p><strong>运行代码</strong></p>
<p>打开命令行, 在 main.go 所在的目录, 运行代码.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go run .</span><br><span class="line">Connected!</span><br><span class="line">Albums found: [&#123;1 Blue Train John Coltrane 56.99&#125; &#123;2 Giant Steps John Coltrane 63.99&#125;]</span><br><span class="line">Album found: &#123;2 Giant Steps John Coltrane 63.99&#125;</span><br></pre></td></tr></table></figure>
<p>下一步, 你将会添加一条专辑信息到数据库中.</p>
<p><br/></p>
<h2 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h2><p>在本小节, 你将使用 Go 执行 SQL 的 <code>INSERT</code> 语句, 来添加一条新数据到数据库中.</p>
<p>你已经了解到了如何使用 <code>Query</code> 和 <code>QueryRow</code> 两个有返回数据的函数来执行 SQL 语句. 那么对于不返回数据的 SQL 语句, 你需要使用 <code>Exec</code></p>
<p><strong>编写代码</strong></p>
<p>1.在 <code>albumByID</code> 函数的下方, 粘贴 <code>addAlbum</code> 函数的代码如下, 用于添加一条新的专辑数据到数据库中, 然后保存 main.go 文件.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// addAlbum 添加指定的专辑信息到数据库中</span></span><br><span class="line"><span class="comment">// 返回新数据到专辑 ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addAlbum</span><span class="params">(alb Album)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">    result, err := db.Exec(<span class="string">&quot;INSERT INTO album (title, artist, price) VALUES (?, ?, ?)&quot;</span>, alb.Title, alb.Artist, alb.Price)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;addAlbum: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    id, err := result.LastInsertId()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;addAlbum: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> id, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这段代码中, 你完成了以下操作:</p>
<ul>
<li>使用 <code>DB.Exec</code> 执行了 <code>INSERT</code> 语句<br>就像 <code>Query</code> 一样, <code>Exec</code> 接收 SQL 语句和这个 SQL 语句的参数值.</li>
<li>校验尝试执行 <code>INSERT</code> 语句时返回的异常</li>
<li>使用 <code>Result.LastInsertId</code> 取回新插入数据的 ID.</li>
<li>校验尝试取回 ID 时返回的异常.</li>
</ul>
<p>2.更新 <code>main</code> 函数对新增的 <code>addAlbum</code> 函数进行调用.</p>
<p>向 <code>func main</code> 的末尾, 添加如下代码:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">albID, err := addAlbum(Album&#123;</span><br><span class="line">    Title:  <span class="string">&quot;The modern Sound of Betty Carter&quot;</span>,</span><br><span class="line">    Artist: <span class="string">&quot;Betty Carter&quot;</span>,</span><br><span class="line">    Price:  <span class="number">49.99</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;ID of added album: %v\n&quot;</span>, albID)</span><br></pre></td></tr></table></figure>
<p>在这段新增代码中, 你现在完成了以下操作:</p>
<ul>
<li>调用 <code>addAlbum</code> 并使用一个新专辑信息作为参数, 将你添加的专辑信息 ID 赋值给一个 <code>albID</code> 变量.</li>
</ul>
<p><strong>运行代码</strong></p>
<p>打开命令行, 在 main.go 所在的目录下, 运行代码.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go run .</span><br><span class="line">Connected!</span><br><span class="line">Albums found: [&#123;1 Blue Train John Coltrane 56.99&#125; &#123;2 Giant Steps John Coltrane 63.99&#125;]</span><br><span class="line">Album found: &#123;2 Giant Steps John Coltrane 63.99&#125;</span><br><span class="line">ID of added album: 5</span><br></pre></td></tr></table></figure>
<p><br/></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>恭喜你! 你刚刚使用 Go 完成了一些对关系型数据库的简单操作.</p>
<p>接下来的一些建议:</p>
<ul>
<li>阅读一下数据存取指南(data access guide), 有一些本教程仅仅浅尝辄止的内容, 在数据存取指南中有更详细的介绍.</li>
<li>如果你刚刚开始使用 Go, 你可以在 <a target="_blank" rel="noopener" href="https://go.dev/doc/effective_go">Effective Go</a> 和 <a target="_blank" rel="noopener" href="https://go.dev/doc/code">How to wirte Go code</a> 中找到非常有用的 Go 语言最佳实践.</li>
<li><a target="_blank" rel="noopener" href="https://tour.golang.org/welcome/1">Go Tour</a> 是一个非常好的入门教程, 循序渐进地介绍了 Go 语言的基础.</li>
</ul>
<p><br/></p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>本小节包含了你跟随本教程构建的程序的完整代码.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;database/sql&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> db *sql.DB</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Album <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID     <span class="keyword">int64</span></span><br><span class="line">    Title  <span class="keyword">string</span></span><br><span class="line">    Artist <span class="keyword">string</span></span><br><span class="line">    Price  <span class="keyword">float32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Capture connection properties.</span></span><br><span class="line">    cfg := mysql.Config&#123;</span><br><span class="line">        User:   os.Getenv(<span class="string">&quot;DBUSER&quot;</span>),</span><br><span class="line">        Passwd: os.Getenv(<span class="string">&quot;DBPASS&quot;</span>),</span><br><span class="line">        Net:    <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">        Addr:   <span class="string">&quot;127.0.0.1:3306&quot;</span>,</span><br><span class="line">        DBName: <span class="string">&quot;recordings&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Get a database handle.</span></span><br><span class="line">    <span class="keyword">var</span> err error</span><br><span class="line">    db, err = sql.Open(<span class="string">&quot;mysql&quot;</span>, cfg.FormatDSN())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pingErr := db.Ping()</span><br><span class="line">    <span class="keyword">if</span> pingErr != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(pingErr)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Connected!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    albums, err := albumsByArtist(<span class="string">&quot;John Coltrane&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Albums found: %v\n&quot;</span>, albums)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hard-code ID 2 here to test the query.</span></span><br><span class="line">    alb, err := albumByID(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Album found: %v\n&quot;</span>, alb)</span><br><span class="line"></span><br><span class="line">    albID, err := addAlbum(Album&#123;</span><br><span class="line">        Title:  <span class="string">&quot;The Modern Sound of Betty Carter&quot;</span>,</span><br><span class="line">        Artist: <span class="string">&quot;Betty Carter&quot;</span>,</span><br><span class="line">        Price:  <span class="number">49.99</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;ID of added album: %v\n&quot;</span>, albID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// albumsByArtist queries for albums that have the specified artist name.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">albumsByArtist</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="params">([]Album, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// An albums slice to hold data from returned rows.</span></span><br><span class="line">    <span class="keyword">var</span> albums []Album</span><br><span class="line"></span><br><span class="line">    rows, err := db.Query(<span class="string">&quot;SELECT * FROM album WHERE artist = ?&quot;</span>, name)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;albumsByArtist %q: %v&quot;</span>, name, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> rows.Close()</span><br><span class="line">    <span class="comment">// Loop through rows, using Scan to assign column data to struct fields.</span></span><br><span class="line">    <span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line">        <span class="keyword">var</span> alb Album</span><br><span class="line">        <span class="keyword">if</span> err := rows.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;albumsByArtist %q: %v&quot;</span>, name, err)</span><br><span class="line">        &#125;</span><br><span class="line">        albums = <span class="built_in">append</span>(albums, alb)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := rows.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;albumsByArtist %q: %v&quot;</span>, name, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> albums, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// albumByID queries for the album with the specified ID.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">albumByID</span><span class="params">(id <span class="keyword">int64</span>)</span> <span class="params">(Album, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">// An album to hold data from the returned row.</span></span><br><span class="line">    <span class="keyword">var</span> alb Album</span><br><span class="line"></span><br><span class="line">    row := db.QueryRow(<span class="string">&quot;SELECT * FROM album WHERE id = ?&quot;</span>, id)</span><br><span class="line">    <span class="keyword">if</span> err := row.Scan(&amp;alb.ID, &amp;alb.Title, &amp;alb.Artist, &amp;alb.Price); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err == sql.ErrNoRows &#123;</span><br><span class="line">            <span class="keyword">return</span> alb, fmt.Errorf(<span class="string">&quot;albumsById %d: no such album&quot;</span>, id)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> alb, fmt.Errorf(<span class="string">&quot;albumsById %d: %v&quot;</span>, id, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> alb, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addAlbum adds the specified album to the database,</span></span><br><span class="line"><span class="comment">// returning the album ID of the new entry</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addAlbum</span><span class="params">(alb Album)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">    result, err := db.Exec(<span class="string">&quot;INSERT INTO album (title, artist, price) VALUES (?, ?, ?)&quot;</span>, alb.Title, alb.Artist, alb.Price)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;addAlbum: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    id, err := result.LastInsertId()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, fmt.Errorf(<span class="string">&quot;addAlbum: %v&quot;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> id, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-none-link" href="/tags/Golang/" rel="tag">Golang</a> <a class="tag tag--primary tag--small t-none-link" href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag">翻译</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/06/14/react/using-protobuf-in-react-application/"
                    data-tooltip="在 React 项目中使用 Protobuf 协议"
                    aria-label="上一篇: 在 React 项目中使用 Protobuf 协议"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/06/06/golang/getting-started-with-generics/"
                    data-tooltip="Golang 泛型入门(译)"
                    aria-label="下一篇: Golang 泛型入门(译)"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://lihanx.github.io/2022/06/09/golang/database-access/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://lihanx.github.io/2022/06/09/golang/database-access/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://lihanx.github.io/2022/06/09/golang/database-access/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2022 lihanxuan. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/06/14/react/using-protobuf-in-react-application/"
                    data-tooltip="在 React 项目中使用 Protobuf 协议"
                    aria-label="上一篇: 在 React 项目中使用 Protobuf 协议"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2022/06/06/golang/getting-started-with-generics/"
                    data-tooltip="Golang 泛型入门(译)"
                    aria-label="下一篇: Golang 泛型入门(译)"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://lihanx.github.io/2022/06/09/golang/database-access/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://lihanx.github.io/2022/06/09/golang/database-access/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://lihanx.github.io/2022/06/09/golang/database-access/"
                    title="分享到 Google+"
                    aria-label="分享到 Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://lihanx.github.io/2022/06/09/golang/database-access/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://lihanx.github.io/2022/06/09/golang/database-access/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://lihanx.github.io/2022/06/09/golang/database-access/"
                        aria-label="分享到 Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>分享到 Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/profile.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">lihanxuan</h4>
        
            <div id="about-card-bio"><p>持续学习, 不断探索</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Python 开发工程师</p>

            </div>
        
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-pwcx44shgfco2srkcnhh8knfc88726ymos4auiuwmqt6fcetpnkbnhqtt4ce.min.js"></script>

<!--SCRIPTS END-->


    




    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>
